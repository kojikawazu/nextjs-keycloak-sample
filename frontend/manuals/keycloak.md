# Keycloak について

## Keycloak概要

Keycloak（キークローク）は、Red Hat社を中心に開発されているオープンソースのアイデンティティ (ID) およびアクセス管理 (IAM: Identity and Access Management) ソリューションです。
以下のような特徴があります。

- シングルサインオン (SSO) 対応
    - OAuth 2.0 / OpenID Connect / SAML 2.0 といった標準的な認証プロトコルをサポートし、複数アプリケーションへのシングルサインオンを実現します。
- 外部IDプロバイダとの連携（アイデンティティブローカー機能）
    - GoogleやGitHubなど、外部のIDプロバイダと連携でき、ユーザの利便性向上につながります。
- ユーザ管理とロール管理
    - 直感的なWeb管理コンソールが用意されており、ユーザやグループ、ロールの管理が容易です。
- 高い拡張性
    - プラグインや独自機能の追加など、ニーズに応じて柔軟にカスタマイズ可能です。
- オンプレ/クラウド環境での運用
    - コンテナやKubernetes上など、さまざまな環境で稼働させやすいのも特徴です。

## Keycloakのメリット

- 標準プロトコルへの幅広い対応
    - OAuth 2.0 / OpenID Connect / SAML 2.0 といった主要な認証・認可プロトコルをサポートしており、既存システムやクラウドサービスとの相互運用性が高い。
- シングルサインオン (SSO) 機能の実装が容易
  複数アプリケーションを一括で認証管理でき、ユーザエクスペリエンスを大幅に向上させることができる。
- ユーザ・グループ・ロールの管理が統合可能
    - 管理画面が充実しているため、運用担当者の負荷を抑えられる。
- 外部プロバイダとのシームレスな連携
    - Google, GitHub, Facebook, Microsoftなど多種多様なIDプロバイダとの連携が可能で、企業やサービスの認証まわりのハードルを下げる。
- 豊富なコミュニティとドキュメント
    - オープンソースであるためコミュニティが活発で、トラブルシューティングや事例が見つかりやすい。

## Keycloakのデメリット

- 学習コスト・初期設定コスト
    - 認証・認可周りの知識がある程度必要であり、機能が豊富な分コンフィギュレーションが複雑になりやすい。
- バージョンアップへの追随
    - オープンソースソフトウェア全般に言えることですが、Keycloakも頻繁にリリースがあるため、バージョン管理を慎重に行う必要がある。
- マルチテナント対応など大規模化への工夫
    - 大規模かつ複数テナントを扱うようなユースケースでは、構成を最適化するための知見が必要となる。
- 独自要件・カスタマイズ対応の開発コスト
    - 高度なカスタマイズを行う場合は、Javaベースで独自拡張を開発する必要がある。

## Keycloakを導入すべきシーン

- 複数サービス間で認証基盤を共通化したい場合
    - SSO導入によりユーザの利便性が向上し、認証まわりの工数を集約できる。
- 外部IDプロバイダとのシームレスな連携を検討している場合
    - 例：ユーザにGoogleやGitHubの認証でログインさせたい。
- アクセスポリシーやロール管理を一元化したい場合
    - 組織的な運用の負荷が低減し、セキュリティポリシーも一貫性を保てる。
- オンプレミス環境もクラウド環境もどちらもサポートしたい場合
    - DockerやKubernetes上で稼働させることも容易。

## Keycloakの導入方法

1. シンプルなDocker Compose運用

- 構成例
    - Docker Compose上でKeycloakコンテナ1つ＋データベース(PostgreSQLやMySQL)
    - 小規模プロジェクトやPoC（概念実証）段階での導入

```
Keycloakコンテナ
|
-> RDB (PostgreSQL / MySQL / その他)
```

2. Kubernetes上のマイクロサービス環境

- 構成例
    - Kubernetes上でKeycloakをデプロイ
    - Microservices (アプリ) とIngressを通じて通信
    - 高可用性(HA)構成や水平スケーリングが必要な場合に適している

```
┌─────────────────────┐
│ Kubernetes Cluster  │
│                     │
│ ┌───────────┐       │
│ │Keycloak   │       │
│ └───────────┘       │
│   ↑ ↑               │
│   │ └───────────────┬────── (アプリ/マイクロサービス)
│   └─────────────────┘
└─────────────────────┘
```

3. オンプレミスやVM環境への導入

- 構成例
    - 既存のオンプレミス環境にVMを立て、Keycloakをインストール
    - Windows ADやLDAPなどの既存認証システムと連携
    - レガシーシステムとSSOを実現したいケースなど

```
[Windows AD / LDAP] --- (LDAP連携) --- [Keycloak VM] --- (認証 / SSO) --- [アプリケーション群]
```

4. クラウドネイティブ（AWS, Azure, GCP 等）

- 構成例
    - AWS EKS（Managed Kubernetes）やGCP GKEなどのマネージドKubernetes上にKeycloakを配置
    - Aurora (PostgreSQL/MySQL互換) などのマネージドDBを使用
    - サーバレスアプリやLambdaとも連携可能

```
[Amazon EKS]
  │
  ├─ [Keycloak Pod]
  │
  └─ [Aurora (RDB)]
```

## まとめ

- Keycloakは、シングルサインオンや統合認証機能を提供するオープンソースのIAMソリューションです。豊富な機能により幅広いアプリケーションと連携可能ですが、導入・学習コストはそれなりに必要となります。
  一方で、DockerやKubernetesなどの現代的なプラットフォームに対応し、外部IDプロバイダとの連携も容易なため、スタートアップから大企業までさまざまなユースケースで利用されています。
  認証基盤を一元化し、運用負荷を低減したいと考える場合は、Keycloakの導入を検討する価値があります。
